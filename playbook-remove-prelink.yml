---
# file: playbook-remove-prelink.yml
#
# Main playbook for the prelink removal project.

- name: Create ephemeral inventory groups
- hosts: all
  tasks:
    - name: Group hosts based on OS distribution and major version
      group_by:
        key: "{{ ansible_os_family }}_{{ ansible_distribution_major_version }}"
      # Run even if we were passed `--check`
      check_mode: no

- name: Remove prelink from RHEL 7 hosts on which it is disabled
  hosts: RedHat_7
  become: yes
  tasks:

    - name: see if prelink is in use
      command: grep -Fxq "PRELINKING=yes" /etc/sysconfig/prelink
      register: prelink_check
      # run even if we were passed `--check'
      check_mode: no
      ignore_errors: yes
      changed_when: no

    - name: remove prelink if it is not needed
      yum:
        name: prelink
        state: absent
      when: prelink_check.rc != 0

# vim:ft=yaml.ansible:
