---
# file: playbook-remove-prelink.yml
#
# Main playbook for the prelink removal project.

- name: Create ephemeral inventory groups
  hosts: all
  tasks:
    - name: Group hosts based on OS distribution and major version
      group_by:
        key: "{{ ansible_os_family }}_{{ ansible_distribution_major_version }}"
      # Run even if we were passed `--check`
      check_mode: no

- name: Disable and remove prelink from RHEL 7 hosts
  hosts: RedHat_7
  become: yes
  gather_facts: no
  tasks:

    - name: check whether prelink is installed
      yum:
        name: prelink
        state: absent
      # Don't actually *remove* prelink, just check whether we *would* remove
      # it.
      check_mode: yes
      register: prelink_remove_simulation

    - when: prelink_remove_simulation.changed
      block:

        - name: disable prelinking in /etc/sysconfig/prelink
          replace:
            path: /etc/sysconfig/prelink
            regexp: 'PRELINKING=yes'
            replace: 'PRELINKING=no'

        - name: undo prelink actions
          shell: prelink -uav >> /var/log/prelink/prelink.log 2>&1

        - name: delete prelink cache
          file:
            path: /etc/prelink.cache
            state: absent

        - name: remove prelink package
          yum:
            name: prelink
            state: absent

# vim:ft=yaml.ansible:
